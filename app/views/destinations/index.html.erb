<div id='map'></div>
<script>
  // generate map
  mapboxgl.accessToken = "pk.eyJ1IjoiY2NjZGVuaGFydCIsImEiOiJjamtzdjNuNHAyMjB4M3B0ZHVoY3l2MndtIn0.jkJIFGPTN7oSkQlHi0xtow";
  
  var map = new mapboxgl.Map({
    container: 'map',
    style: "mapbox://styles/mapbox/streets-v11",
    center: [
      -71.073329, 42.352738
    ],
    zoom: 12
  });
  
  // https://medium.com/actualize-network/sending-post-requests-in-rails-5-1-without-jquery-ff89f6f80487
  // ajax request to add a destination
  function addgeo(lat, long, name, keywords) {
    console.log("lat: ", lat);
    console.log("long: ", long);
    fetch('/users/<%= @user.id %>/destinations.json', {
      method: 'post',
      body: JSON.stringify({lat: lat, long: long, name: name, keywords: keywords.join(", ")}),
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': Rails.csrfToken()
      },
      credentials: 'same-origin'
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      console.log(data);
    });
  }
  
  // retrieve necessary elements on map load
  map.on('load', function() {
  
    // geocoder allowing for destination searches
    var geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapgoxgl: mapboxgl
    });
  
    map.addControl(geocoder);
  
    // display marker for a search result
    // TODO: fix unknown syntax error in 'addgeo' function call
    // TODO: style button
    geocoder.on('result', function(ev) {
      console.log(ev);
      var coords = ev.result.center;
      var name = ev.result["text_en-US"];
      console.log(name);
      var keywords = JSON.stringify(ev.result.properties.category.split(", "));
      console.log(keywords);
      var popup = new mapboxgl.Popup()
        .setHTML(
          `<p style="font-weight: bold">${ name }</p>
          <br>
          <button type="button" id="add_geo" onclick='addgeo(${ coords[1] }, ${ coords[0] }, ${ name }, ${ keywords })'>Add</button>
          `);
      new mapboxgl.Marker({ color: "orange" })
        .setLngLat(coords)
        .setPopup(popup)
        .addTo(map);
    });
  
    // add markers for each existing destination
    // TODO: add link to 'show' page for each dest
    <% @destinations.each do |dest| %>
      console.log(<% dest %>);
      var coords = [<%= dest.long %>, <%= dest.lat %>];
      var popup = new mapboxgl.Popup({ offset: 25 })
        .setHTML(`<p style='font-weight:bold'><%= dest.name %></p>`);
      new mapboxgl.Marker()
        .setLngLat(coords)
        .setPopup(popup)
        .addTo(map);
    <% end %>
  });
  
  // Change the cursor to a pointer when it enters a feature in the 'symbols' layer.
  // TODO: make this work
  map.on('mouseenter', 'marker', function () {
    map.getCanvas().style.cursor = 'pointer';
  });
</script>
